#!/usr/bin/env node

var fs = require('fs');
var _ = require('lodash');
var opener = require('opener');
var colors = require('colors');
var portfinder = require('portfinder');
var argv = require('optimist').argv;
var ip = require('../lib/ip');
var openBrowser = require('../lib/open-browser');


if (argv.h || argv.help) {
  console.log([
    "usage: open-browser [path] [options]",
    "",
    "options:",
    "  -p                 Port to use [8080]",
    "  -a                 Address to use [0.0.0.0]",
    "  -d                 Show directory listings [true]",
    "  -i                 Display autoIndex [true]",
    "  -e                 Set environment: [none], debug, daily, publish.",
    "  -s --silent        Suppress log messages from output",
    "  --cors             Enable CORS via the 'Access-Control-Allow-Origin' header",
    "  -c                 Set cache time (in seconds). e.g. -c10 for 10 seconds.",
    "  -t                 Using template handler 'config.js'.",
    "                     To disable caching, use -c-1.",
    "  -h --help          Print this list and exit."
  ].join('\n'));
  process.exit();
}

var port = argv.p || parseInt(process.env.PORT, 10),
  host = argv.a || '0.0.0.0',
  log = (argv.s || argv.silent) ? (function() {}) : console.log,
  requestLogger;

if (!argv.s && !argv.silent) {
  requestLogger = function(req) {
    log('[%s] "%s %s" "%s"', (new Date).toUTCString(), req.method.cyan, req.url.cyan, req.headers['user-agent']);
  }
}

if (!port) {
  portfinder.basePort = 8080;
  portfinder.getPort(function(err, port) {
    if (err) throw err;
    listen(port);
  });
} else {
  listen(port);
}

function listen(port) {
  var options = {
    root: argv._[0],
    cache: argv.c,
    showDir: argv.d,
    autoIndex: argv.i,
    logFn: requestLogger
  };

  var config = require('../lib/config');
  if (argv.t) {
    var conf = require(process.cwd() + '/browser-config');
    _.assign(config, conf);
  }

  if (argv.e) {
    options.config = config[argv.e];
  } else {
    options.config = config['none'];
  }

  options.proxy = config['proxy'];

  if (argv.cors) {
    options.headers = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Headers': 'Origin, X-Requested-With, Content-Type, Accept'
    };
  }

  var server = openBrowser.createServer(options);
  server.listen(port, host, function() {
    var url = 'http://' + ip.address() + ':' + port.toString();

    log('Starting up open-browser, serving '.yellow + server.root.cyan + ' on port: '.yellow + port.toString().cyan);
    log('Server url: '.yellow + url.cyan);
    log('Hit CTRL-C to stop the server');

    opener(url);
  });
}

if (process.platform !== 'win32') {
  //
  // Signal handlers don't work on Windows.
  //
  process.on('SIGINT', function() {
    log('open-browser stopped.'.red);
    process.exit();
  });
}